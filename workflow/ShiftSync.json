{
  "name": "shifts",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "=Rol: Eres un agente experto en extracciÃ³n estructurada de informaciÃ³n desde mensajes de WhatsApp relacionados con turnos de trabajo de meseros.\n\nTu tarea es identificar, interpretar y estructurar todos los turnos presentes en el mensaje, incluso si la redacciÃ³n cambia, si incluye varias fechas, si tiene distintos dÃ­as, o si hay textos adicionales.\n\nâš ï¸ Instrucciones obligatorias:\n\nSiempre debes usar la herramienta llamada Get_Price_Date que tienes a tu disposiciÃ³n para saber el precio del turno y su fecha.\n\nAl usar la herramienta obtienes:\n- el precio del turno\n- la fecha en formato ISO 8601\n\nUsa la herramienta para cada turno individualmente.\n\nâš ï¸ Formato de salida OBLIGATORIO:\n\nSiempre debes devolver un JSON vÃ¡lido que sea un OBJETO con la siguiente estructura raÃ­z:\n\n{\n  \"is_shift\": boolean,\n  \"shifts\": []\n}\n\n- `is_shift` debe ser `true` Ãºnicamente si el mensaje corresponde a una asignaciÃ³n real de uno o mÃ¡s turnos de trabajo.\n- `is_shift` debe ser `false` si el mensaje NO corresponde a una asignaciÃ³n de turno (mensajes informativos, saludos, recordatorios, conversaciones, etc).\n- Si `is_shift` es `false`, `shifts` debe ser un array vacÃ­o.\n- Si `is_shift` es `true`, `shifts` debe contener uno o mÃ¡s objetos de turno.\n\nNunca devuelvas un array como salida raÃ­z.\nNunca agregues texto fuera del JSON.\n\nâš ï¸ Estructura obligatoria de cada turno dentro de `shifts`:\n\nCada turno debe tener esta estructura:\n\n{\n  \"id\": \"id del turno\",\n  \"precio\": 0,\n  \"fecha\": \"2025-12-03T00:00:00\",\n  \"lugar\": \"Lugar del turno\",\n  \"tipo_de_turno\": \"mesas | mesero | patin | etc\",\n  \"hora\": \"8:00 AM\"\n}\n\nEl `id` es un identificador comÃºn para todos los turnos extraÃ­dos del mismo mensaje y es el siguiente:\n\n{{ \n$json.output.action === \"update\" ? \n$('WhatsApp Trigger').first().json.messages[0].context.id\n: \n$('WhatsApp Trigger').first().json.messages[0].id\n}}\n\nUsa exactamente ese ID para todos los turnos del mensaje.\n\nSi el mensaje contiene varias fechas (ej: â€œSÃBADO 15, DOMINGO 16 Y LUNES 17â€), debes generar un objeto de turno por cada fecha dentro del array `shifts`.\n\nSi algo no aparece explÃ­citamente en el mensaje, intenta inferirlo.\nSi no es posible inferirlo, devuelve el valor como `null`.\n\nðŸ” Preguntas que debes responder internamente al procesar el mensaje:\n\n- Â¿El mensaje corresponde realmente a una asignaciÃ³n de turno?\n- Â¿CuÃ¡ntos turnos diferentes hay? (uno por cada fecha)\n- Â¿CuÃ¡l es el lugar?\n- Â¿CuÃ¡l es el tipo de turno? (mesas, mesero, patÃ­n, bebidas, etc.)\n- Â¿CuÃ¡l es la hora?\n- Â¿QuÃ© fechas exactas con dÃ­a, mes y aÃ±o corresponden? (obtÃ©n el aÃ±o usando la herramienta)\n- Â¿CuÃ¡l es el precio? (usa siempre la herramienta)\n\nðŸ“© Ejemplo de mensaje tÃ­pico de asignaciÃ³n de turnos:\n\nBuen dÃ­a, EstÃ¡ solicitado para turno  \nFecha: SÃBADO 15, DOMINGO 16 Y LUNES 17 DE NOVIEMBRE  \nHora: 8:00 AM  \nLugar: CLUB LOMAS DEL VIENTO  \nÃrea: MESAS  \nDirecciÃ³n: Pan-American Highway, Piedecuesta, Santander\n\nðŸ“¤ Ejemplo de salida esperada cuando SÃ es un turno:\n\n{\n  \"is_shift\": true,\n  \"shifts\": [\n    {\n      \"id\": \"turno-17332498123\",\n      \"precio\": 60000,\n      \"fecha\": \"2025-11-15T00:00:00\",\n      \"lugar\": \"CLUB LOMAS DEL VIENTO\",\n      \"tipo_de_turno\": \"mesas\",\n      \"hora\": \"8:00 AM\"\n    }\n  ]\n}\n\nðŸ“¤ Ejemplo de salida esperada cuando NO es un turno:\n\n{\n  \"is_shift\": false,\n  \"shifts\": []\n}\n\nEsta es la asignaciÃ³n de turno que te enviaron en esta ocasiÃ³n:\n\n{{ $json.text ?? \"\" }}\n\n{{ $('WhatsApp Trigger').first().json.messages[0].text.body }}",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        656,
        -64
      ],
      "id": "c40f2902-6c16-4e35-b282-04b9b780dc5b",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        608,
        128
      ],
      "id": "52efae31-8b2c-41d6-99d5-b5e2714bcf34",
      "name": "Mistral Cloud Chat Model",
      "credentials": {
        "mistralCloudApi": {
          "id": "eBYxq0MGu8Gf3woR",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const result = $input.first().json.output\nconst { is_shift } = result\n\nif (is_shift) return result.shifts\nelse return []"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        -64
      ],
      "id": "e3aed18b-165d-4df7-ab4f-812dd1ff0990",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "2a97b9ad-7306-80f4-aa39-d85da3e68a26",
          "mode": "list",
          "cachedResultName": "Turnos mesero",
          "cachedResultUrl": "https://www.notion.so/2a97b9ad730680f4aa39d85da3e68a26"
        },
        "title": "={{ $json.id }}",
        "simple": false,
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Fecha|date",
              "includeTime": false,
              "date": "={{ $json.fecha }}"
            },
            {
              "key": "Hora|rich_text",
              "textContent": "={{ $json.hora }}"
            },
            {
              "key": "Tipo|rich_text",
              "textContent": "={{ $json.tipo_de_turno }}"
            },
            {
              "key": "Lugar|rich_text",
              "textContent": "={{ $json.lugar }}"
            },
            {
              "key": "Valor|number",
              "numberValue": "={{ $json.precio }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        1152,
        -64
      ],
      "id": "98eca5eb-f177-4b0e-8dd4-ebc860b04762",
      "name": "Create a database page",
      "credentials": {
        "notionApi": {
          "id": "RAMqWHgP8zteCpFh",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "description": "Herramienta que te dice el precio en pesos colombianos COP que tiene un turno de mesero dependiendo de el dia en el que se realice junto a su fecha en formato ISO 8601",
        "jsCode": "const { isHoliday } = require('colombian-holidays');\n\nconst { day, month } = $json\n\nconst date = new Date()\ndate.setDate(parseInt(day, 10))\ndate.setMonth(parseInt(month, 10) - 1)\n\nif (isHoliday(date) || date.getDay() == 0) {\n  return `\n    precio: 110000,\n    fecha: ${date.toISOString().split('.')[0]}\n  `\n} else {\n  return `\n    precio: 60000,\n    fecha: ${date.toISOString().split('.')[0]}\n  `\n}",
        "specifyInputSchema": true,
        "jsonSchemaExample": "{\n\t\"day\": 8,\n    \"month\": 10\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        752,
        128
      ],
      "id": "50227279-2439-4b71-aa57-3a98e36c133d",
      "name": "Get_Price_Date"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"is_shift\": {\n      \"type\": \"boolean\"\n    },\n    \"shifts\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"id\": {\n            \"type\": \"string\"\n          },\n          \"precio\": {\n            \"type\": \"number\"\n          },\n          \"fecha\": {\n            \"type\": \"string\"\n          },\n          \"lugar\": {\n            \"type\": \"string\"\n          },\n          \"tipo_de_turno\": {\n            \"type\": \"string\"\n          },\n          \"hora\": {\n            \"type\": \"string\"\n          }\n        },\n        \"required\": [\n          \"id\",\n          \"precio\",\n          \"fecha\",\n          \"lugar\",\n          \"tipo_de_turno\",\n          \"hora\"\n        ]\n      }\n    }\n  },\n  \"required\": [\n    \"is_shift\",\n    \"shifts\"\n  ]\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        896,
        128
      ],
      "id": "85830253-37c6-48e0-9ae6-b2ad36b445d9",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2a97b9ad-7306-80f4-aa39-d85da3e68a26",
          "mode": "list",
          "cachedResultName": "Turnos mesero",
          "cachedResultUrl": "https://www.notion.so/2a97b9ad730680f4aa39d85da3e68a26"
        },
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "id|title",
              "condition": "equals",
              "titleValue": "={{ $('WhatsApp Trigger').item.json.messages[0].context.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        -64,
        -192
      ],
      "id": "a944bb59-eda3-46cf-aee9-d6e1d0ee3537",
      "name": "Get many database pages",
      "credentials": {
        "notionApi": {
          "id": "RAMqWHgP8zteCpFh",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "operation": "archive",
        "pageId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        }
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        144,
        -192
      ],
      "id": "87a158dd-65e0-432a-8796-f2c007ddd2ad",
      "name": "Archive page",
      "credentials": {
        "notionApi": {
          "id": "RAMqWHgP8zteCpFh",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -1312,
        -64
      ],
      "id": "0d262c45-bc4d-4885-8b81-929ce089631e",
      "name": "WhatsApp Trigger",
      "webhookId": "9cf4dbf6-fbeb-4403-ab63-89edf073df1e",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "PuzjsiHQISkOhnmW",
          "name": "WhatsApp OAuth account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un agente de clasificaciÃ³n de intenciÃ³n.\n\nTu tarea es analizar el mensaje proporcionado y determinar Ãºnicamente la intenciÃ³n principal del usuario respecto a los turnos de mesero.\n\nDebes clasificar el mensaje en una de las siguientes acciones:\n\n\"create\": el usuario desea crear o registrar un nuevo turno de mesero.\n\n\"update\": el usuario desea modificar, cambiar o corregir un turno de mesero existente.\n\n\"delete\": el usuario desea eliminar, cancelar o borrar un turno de mesero.\n\n\"price\": el usuario desea saber en que valor va la quince del mes\n\n\"nothing\": el mensaje no estÃ¡ relacionado con la creaciÃ³n, modificaciÃ³n o eliminaciÃ³n de turnos de mesero, o no expresa una acciÃ³n clara.\n\nReglas estrictas\n\nAnaliza Ãºnicamente el contenido del mensaje.\n\nNo expliques tu decisiÃ³n.\n\nNo agregues texto adicional.\n\nResponde exclusivamente con un objeto JSON vÃ¡lido en el siguiente formato:\n\n{\n  \"action\": \"create\" | \"update\" | \"delete\" | \"nothing\" | \"price\"\n}\n\nMensaje del usuario a analizar:\n{{ $json.messages[0].text.body }}",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -1072,
        -64
      ],
      "id": "5ec5511a-e835-476e-a8a0-f7d727aaa323",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "model": "mistral-large-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        -1072,
        128
      ],
      "id": "cb857217-4a84-4aa1-b64d-7d09598d26a3",
      "name": "Mistral Cloud Chat Model1",
      "credentials": {
        "mistralCloudApi": {
          "id": "eBYxq0MGu8Gf3woR",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"action\": {\n      \"type\": \"string\",\n      \"enum\": [\"create\", \"update\", \"delete\", \"nothing\", \"price\"]\n    }\n  },\n  \"required\": [\"action\"],\n  \"additionalProperties\": false\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -928,
        176
      ],
      "id": "fae7e25f-5d00-493a-a07a-a80d894eae09",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "4503cd25-c32f-490b-a29e-bf812f7a8f88",
                    "leftValue": "={{ $json.output.action }}",
                    "rightValue": "price",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.output.action }}",
                    "rightValue": "delete",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "498bb232-7043-4688-83af-d9a8216e0df8"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b762105a-4ca2-492d-8edb-62589b304ec4",
                    "leftValue": "={{ $json.output.action }}",
                    "rightValue": "create",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "90311c9a-af63-4230-9045-a0ae75af7e9d",
                    "leftValue": "={{ $json.output.action }}",
                    "rightValue": "update",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "02a43eaa-1437-40f5-b3d6-97b6bde2243e",
                    "leftValue": "={{ $json.output.action }}",
                    "rightValue": "nothing",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -672,
        -112
      ],
      "id": "9d213256-dcd9-48c6-a0b8-cf8912ff36c9",
      "name": "Switch"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4068ad68-a668-44d0-af91-9d7782fe2560",
              "leftValue": "={{ $('WhatsApp Trigger').item.json.messages[0].context.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -288,
        -176
      ],
      "id": "d9375dae-6b5d-4361-be2a-d29e308589f0",
      "name": "If1",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfunction formatShifts(turnos) {\n  return turnos\n    .map((t, index) => {\n      const fecha = t.property_fecha?.start ?? 'Fecha no definida';\n      const hora = t.property_hora ?? 'Hora no definida';\n      const lugar = t.property_lugar ?? 'Lugar no definido';\n      const tipo = t.property_tipo ?? 'Tipo no definido';\n      const valor = typeof t.property_valor === 'number'\n        ? `$${t.property_valor.toLocaleString('es-CO')}`\n        : 'Valor no definido';\n\n      return (\n        `Turno ${index + 1}\\n` +\n        `â€¢ Lugar: ${lugar}\\n` +\n        `â€¢ Tipo: ${tipo}\\n` +\n        `â€¢ Fecha: ${fecha}\\n` +\n        `â€¢ Hora: ${hora}\\n` +\n        `â€¢ Pago: ${valor}`\n      );\n    })\n    .join('\\n\\n');\n}\n\nconst items = $('Get many database pages1').all()\nconst turnos = items.map(i => i.json);\n\nreturn [{text: `\n  Debes agregar el siguiente turno o turnos\n  \n  ${formatShifts(turnos)}\n\n  pero cumpliedo la siguiente condicion:\n  \n`}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        32
      ],
      "id": "02cf79c4-19c8-4c18-9673-77c11e62e62b",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "896483376887360",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
        "textBody": "No se realizo ninguna acciÃ³n.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -288,
        240
      ],
      "id": "24f8c733-b06c-4e11-8632-1896b8060d3f",
      "name": "Send message",
      "webhookId": "ff4aa37e-702c-4afd-867c-90dd2867676c",
      "credentials": {
        "whatsAppApi": {
          "id": "5hn9BODf5lXKOVN0",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2a97b9ad-7306-80f4-aa39-d85da3e68a26",
          "mode": "list",
          "cachedResultName": "Turnos mesero",
          "cachedResultUrl": "https://www.notion.so/2a97b9ad730680f4aa39d85da3e68a26"
        },
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "id|title",
              "condition": "equals",
              "titleValue": "={{ $('WhatsApp Trigger').item.json.messages[0].context.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        -64,
        32
      ],
      "id": "b592c288-0011-4a7b-901c-ed8a5f9f3cce",
      "name": "Get many database pages1",
      "credentials": {
        "notionApi": {
          "id": "RAMqWHgP8zteCpFh",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "operation": "archive",
        "pageId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        }
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        144,
        32
      ],
      "id": "ff4f43d3-2287-4c26-ac13-dd9bdadae176",
      "name": "Archive page1",
      "credentials": {
        "notionApi": {
          "id": "RAMqWHgP8zteCpFh",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4068ad68-a668-44d0-af91-9d7782fe2560",
              "leftValue": "={{ $('WhatsApp Trigger').item.json.messages[0].context.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -288,
        48
      ],
      "id": "312effd7-61cb-4856-a4e4-4305e6f7cf98",
      "name": "If",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "896483376887360",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
        "textBody": "={{ $('Archive page').all().length > 1 ? \"Se eliminaron los turnos correctamente\" : \"Se elimino el turno correctamente\" }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        368,
        -192
      ],
      "id": "41eeaa73-f205-4d44-8cc2-79d9a2a780f0",
      "name": "Send message1",
      "webhookId": "ff4aa37e-702c-4afd-867c-90dd2867676c",
      "executeOnce": true,
      "credentials": {
        "whatsAppApi": {
          "id": "5hn9BODf5lXKOVN0",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "896483376887360",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').first().json.messages[0].from }}",
        "textBody": "={{ $('Create a database page').all().length > 1 ? \"Se agregaron los turnos correctamente\" : \"Se agrego el turno correctamente\" }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1600,
        16
      ],
      "id": "65aaba61-ad83-450b-9b4a-6c19318c63ad",
      "name": "Send message2",
      "webhookId": "ff4aa37e-702c-4afd-867c-90dd2867676c",
      "executeOnce": true,
      "credentials": {
        "whatsAppApi": {
          "id": "5hn9BODf5lXKOVN0",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6e7c3ee4-746f-4226-9979-af46b70a62ea",
              "leftValue": "={{ $('AI Agent1').first().json.output.action }}",
              "rightValue": "update",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1360,
        -64
      ],
      "id": "a95d4145-b7b4-4249-93cb-ff6be2f279a3",
      "name": "If2"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "896483376887360",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
        "textBody": "={{ $('Create a database page').all().length > 1 ? \"Se actualizaron los turnos correctamente\" : \"Se actualizo el turno correctamente\" }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1600,
        -144
      ],
      "id": "3a0e1454-f5d3-4379-9a46-d7c3a062cb17",
      "name": "Send message3",
      "webhookId": "ff4aa37e-702c-4afd-867c-90dd2867676c",
      "executeOnce": true,
      "credentials": {
        "whatsAppApi": {
          "id": "5hn9BODf5lXKOVN0",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "30 23 1,15 * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -912,
        -576
      ],
      "id": "e917b0e0-9852-4cca-a447-d250f8cb5968",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7daf5d3a-2e52-4924-b30d-c51e97c3de19",
              "leftValue": "={{ new Date().getDate() }}",
              "rightValue": 16,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -288,
        -384
      ],
      "id": "a445a377-e597-4f25-90df-ddb9b2ff3ee4",
      "name": "If3",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "const shifts = $input.all()\n\nconst prices = shifts.map((shift) => shift.json.property_valor)\n\nconst summary = prices.reduce((acc, n) => acc + n, 0);\n\nconst summaryCop = new Intl.NumberFormat('es-CO', {\n  style: 'currency',\n  currency: 'COP',\n  minimumFractionDigits: 0\n}).format(summary);\n\nreturn [{ \n  summary: summaryCop.replace(/\\s+/g, ''),\n  summaryNum: summary\n}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        -400
      ],
      "id": "f6b15594-dab4-4075-9e1b-488b6a8ea88d",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "896483376887360",
        "recipientPhoneNumber": "=573219074881",
        "textBody": "=La quincena va en {{ $json.summary }} COP.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        432,
        -400
      ],
      "id": "a13d8499-a2eb-4612-ae3a-f1402e2ca0de",
      "name": "Send message4",
      "webhookId": "18d4a0ba-af87-4278-9e86-fcd176d4cfa1",
      "credentials": {
        "whatsAppApi": {
          "id": "5hn9BODf5lXKOVN0",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2a97b9ad-7306-80f4-aa39-d85da3e68a26",
          "mode": "list",
          "cachedResultName": "Turnos mesero",
          "cachedResultUrl": "https://www.notion.so/2a97b9ad730680f4aa39d85da3e68a26"
        },
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "key": "Fecha|date",
              "condition": "before",
              "date": "={{ new Date() }}"
            },
            {
              "key": "Fecha|date",
              "condition": "after",
              "date": "={{ new Date(new Date().getFullYear(), new Date().getMonth() - 1, 15) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        48,
        -368
      ],
      "id": "ea7b28e4-2c20-49c2-9916-5ed31ed1252b",
      "name": "Quincena 2",
      "credentials": {
        "notionApi": {
          "id": "RAMqWHgP8zteCpFh",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2a97b9ad-7306-80f4-aa39-d85da3e68a26",
          "mode": "list",
          "cachedResultName": "Turnos mesero",
          "cachedResultUrl": "https://www.notion.so/2a97b9ad730680f4aa39d85da3e68a26"
        },
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "key": "Fecha|date",
              "condition": "on_or_before",
              "date": "={{ new Date() }}"
            },
            {
              "key": "Fecha|date",
              "condition": "after",
              "date": "={{ new Date(new Date().getFullYear(), new Date().getMonth(), 0) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        -96,
        -400
      ],
      "id": "58299ace-4b51-4e0f-b565-b5ab59c38529",
      "name": "Quincena 1",
      "credentials": {
        "notionApi": {
          "id": "RAMqWHgP8zteCpFh",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "6bcebf59-81c4-4b6c-ad41-99dbe9a46928",
              "leftValue": "={{ new Date().getDate() }}",
              "rightValue": 15,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            },
            {
              "id": "d40d1ac6-3582-4e1e-aa86-8b3461d0b883",
              "leftValue": "={{ parseInt(new Date().getMonth()) }}",
              "rightValue": "={{ parseInt(new Date(Date.now() + 86400000).getMonth()) }}\n",
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -672,
        -368
      ],
      "id": "1080c4e3-ba8c-4ae2-a2a5-350a5fe95180",
      "name": "If4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        432,
        -560
      ],
      "id": "377731ed-394e-4e8a-83b3-a6b446bcceaa",
      "name": "Merge"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "2a97b9ad-7306-80f4-aa39-d85da3e68a26",
          "mode": "list",
          "cachedResultName": "Turnos mesero",
          "cachedResultUrl": "https://www.notion.so/2a97b9ad730680f4aa39d85da3e68a26"
        },
        "title": "=ðŸ’° Quincena",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Valor|number",
              "numberValue": "={{ $('Code in JavaScript2').first().json.summaryNum }}"
            },
            {
              "key": "Fecha|date",
              "date": "={{ new Date() }}"
            },
            {
              "key": "Lugar|rich_text",
              "textContent": "Quincena"
            },
            {
              "key": "Tipo|rich_text",
              "textContent": "Quincena"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        640,
        -560
      ],
      "id": "41ac5542-715b-4597-af75-3c831bb79ad1",
      "name": "Create a database page1",
      "executeOnce": true,
      "credentials": {
        "notionApi": {
          "id": "RAMqWHgP8zteCpFh",
          "name": "Notion account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Create a database page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get_Price_Date": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Get many database pages": {
      "main": [
        [
          {
            "node": "Archive page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Archive page": {
      "main": [
        [
          {
            "node": "Send message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Get many database pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many database pages1": {
      "main": [
        [
          {
            "node": "Archive page1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Get many database pages1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Archive page1": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a database page": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Send message3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Quincena 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Quincena 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Send message4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Quincena 2": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Quincena 1": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Create a database page1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e534d1cf-8101-45f7-8727-b523268c768d",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d5b8764fac9936db34873e982e96f35d94691a523181a39ccdd1d45096b54f97"
  },
  "id": "PG6EfBmJtYCiIqAQ",
  "tags": []
}